# Deployment Configuration Example
# Copy this file to your product root as 'axon.config.yml' and customize
#
# IMPORTANT: All deployment scripts run from your LOCAL MACHINE
# and SSH to both Application Server and System Server to execute commands.
#
# LEGEND:
#   [REQUIRED] - Must be set, deployment will fail if missing
#   [OPTIONAL] - Can be omitted, will use default value shown in comment

# ==============================================================================
# Product Information
# ==============================================================================
product:
  name: "my-product"              # [REQUIRED] Product name (used for container/image naming)
  description: "My Application"   # [OPTIONAL] Product description (for documentation only)

# ==============================================================================
# Container Registry Configuration
# ==============================================================================
# Choose ONE registry provider and configure its section below.
# Supported providers: docker_hub, aws_ecr, google_gcr, azure_acr

registry:
  provider: "aws_ecr"  # [REQUIRED] Registry provider to use

  # --------------------------------------------------------------------------
  # Docker Hub Configuration
  # --------------------------------------------------------------------------
  # Uncomment and configure this section if using Docker Hub
  # docker_hub:
  #   username: "myuser"                          # [REQUIRED] Docker Hub username
  #   access_token: "${DOCKER_HUB_TOKEN}"         # [REQUIRED] Personal Access Token (use env var for security)
  #   namespace: "myuser"                         # [OPTIONAL] Namespace (default: username)
  #   repository: "my-product"                    # [OPTIONAL] Repository name (default: product.name)

  # --------------------------------------------------------------------------
  # AWS ECR Configuration (Example - Currently Active)
  # --------------------------------------------------------------------------
  aws_ecr:
    profile: "default"                            # [REQUIRED] AWS CLI profile name
    region: "ap-northeast-1"                      # [REQUIRED] AWS region for ECR
    account_id: "123456789012"                    # [REQUIRED] AWS account ID (12 digits)
    repository: "my-product"                      # [OPTIONAL] ECR repository name (default: product.name)

  # --------------------------------------------------------------------------
  # Google Container Registry Configuration
  # --------------------------------------------------------------------------
  # Uncomment and configure this section if using GCR
  # google_gcr:
  #   project_id: "my-gcp-project"                # [REQUIRED] GCP project ID
  #   location: "us"                              # [OPTIONAL] Location: us, eu, asia (default: us)
  #   service_account_key: "~/gcp-key.json"       # [OPTIONAL] Service account key file (if not using gcloud CLI)
  #   use_artifact_registry: false                # [OPTIONAL] Use Artifact Registry instead of GCR (default: false)
  #   repository: "my-product"                    # [OPTIONAL] Repository name (default: product.name)

  # --------------------------------------------------------------------------
  # Azure Container Registry Configuration
  # --------------------------------------------------------------------------
  # Uncomment and configure this section if using ACR
  # azure_acr:
  #   registry_name: "myregistry"                 # [REQUIRED] ACR registry name (without .azurecr.io)
  #   # Authentication method (choose ONE):
  #   # Option 1: Service Principal (recommended for CI/CD)
  #   service_principal_id: "sp-app-id"           # [OPTIONAL] Service principal application ID
  #   service_principal_password: "${AZURE_SP_PASSWORD}"  # [OPTIONAL] Service principal secret (use env var)
  #   # Option 2: Admin User (must be enabled in Azure Portal)
  #   # admin_username: "myregistry"              # [OPTIONAL] Admin username
  #   # admin_password: "${AZURE_ADMIN_PASSWORD}" # [OPTIONAL] Admin password (use env var)
  #   # Option 3: Azure CLI (no credentials needed if 'az login' is active)
  #   repository: "my-product"                    # [OPTIONAL] Repository name (default: product.name)

# IMPORTANT: Security Best Practices for Credentials
# - Use environment variables for sensitive values: ${VAR_NAME}
# - Never commit credentials directly in this file
# - For Docker Hub: Use Personal Access Tokens, not passwords
# - For AWS: Use AWS CLI profiles with proper IAM permissions
# - For GCP: Use service account keys stored securely
# - For Azure: Use service principals or Azure CLI authentication

# ==============================================================================
# Server Configuration
# ==============================================================================
servers:
  # System Server (nginx + SSL)
  system:
    host: "system.example.com"           # [REQUIRED] System Server IP or hostname
    user: "ubuntu"                       # [REQUIRED] SSH user
    ssh_key: "~/.ssh/system_server_key"  # [REQUIRED] SSH private key path (must exist locally)

  # Application Server (Docker containers)
  application:
    host: "app.example.com"              # [REQUIRED] Application Server public IP/hostname (for SSH)
    private_ip: "10.0.1.10"              # [REQUIRED] Private IP within VPC (for nginx upstream)
    user: "ubuntu"                       # [REQUIRED] SSH user
    ssh_key: "~/.ssh/app_server_key"     # [REQUIRED] SSH private key path (must exist locally)

# ==============================================================================
# nginx Configuration
# ==============================================================================
# AXON automatically manages nginx configuration on System Server
# Run 'axon setup system-server' to initialize the nginx configuration
nginx:
  # Domain configuration for each environment
  # If not specified, uses catch-all server name "_" (accepts any domain)
  domain:
    production: "example.com"            # [OPTIONAL] Domain for production environment
    staging: "staging.example.com"       # [OPTIONAL] Domain for staging environment
    # development: "dev.example.com"     # [OPTIONAL] Domain for development environment

  # SSL certificate configuration for each environment
  # Provide paths to SSL certificate files on System Server
  # If not specified, HTTPS server block will not be generated
  ssl:
    production:
      certificate: "/etc/ssl/certs/example.com.crt"      # [REQUIRED for HTTPS] SSL certificate path
      certificate_key: "/etc/ssl/private/example.com.key" # [REQUIRED for HTTPS] SSL private key path
    staging:
      certificate: "/etc/ssl/certs/staging.example.com.crt"      # [REQUIRED for HTTPS] SSL certificate path
      certificate_key: "/etc/ssl/private/staging.example.com.key" # [REQUIRED for HTTPS] SSL private key path
    # development:
    #   certificate: "/etc/ssl/certs/dev.example.com.crt"
    #   certificate_key: "/etc/ssl/private/dev.example.com.key"

  # Proxy settings (reasonable defaults provided)
  proxy:
    timeout: 60                          # [OPTIONAL] Proxy timeout in seconds (default: 60)
    buffer_size: "128k"                  # [OPTIONAL] Proxy buffer size (default: 128k)
    buffers: "4 256k"                    # [OPTIONAL] Number and size of proxy buffers (default: 4 256k)
    busy_buffers_size: "256k"            # [OPTIONAL] Busy buffers size (default: 256k)

  # Advanced: Custom nginx properties (optional)
  # Add any nginx directives here - they will be inserted into each server block
  # This gives you full control over nginx configuration without modifying scripts
  # custom_properties: |                 # [OPTIONAL] Raw nginx directives
  #   # Custom headers
  #   add_header X-Frame-Options "SAMEORIGIN" always;
  #   add_header X-Content-Type-Options "nosniff" always;
  #   add_header X-XSS-Protection "1; mode=block" always;
  #
  #   # Client body size limit
  #   client_max_body_size 50M;
  #
  #   # Rate limiting (requires zone definition in main nginx.conf)
  #   # limit_req zone=api_limit burst=10 nodelay;
  #
  #   # Proxy caching (requires cache definition in main nginx.conf)
  #   # proxy_cache my_cache;
  #   # proxy_cache_valid 200 60m;

  # Advanced: nginx path overrides (rarely needed)
  # paths:
  #   config: "/etc/nginx/nginx.conf"    # [OPTIONAL] Main nginx config path (default: /etc/nginx/nginx.conf)
  #   axon_dir: "/etc/nginx/axon.d"      # [OPTIONAL] AXON config directory (default: /etc/nginx/axon.d)

# ==============================================================================
# Environment Configurations
# ==============================================================================
# You can define any number of environments (production, staging, development, qa, etc.)
# Each environment can have its own configuration
environments:
  # Production Environment
  production:
    env_path: "/home/ubuntu/apps/my-product/.env.production"  # [REQUIRED] Full path to .env file on Application Server
    image_tag: "production"                                   # [OPTIONAL] Docker image tag (default: environment name)

  # Staging Environment
  staging:
    # Port is auto-assigned by Docker (no manual configuration needed)
    env_path: "/home/ubuntu/apps/my-product/.env.staging"  # [REQUIRED] Full path to .env file on Application Server
    image_tag: "staging"                                   # [OPTIONAL] Docker image tag (default: environment name)

  # Custom Environment Example (optional)
  # You can define any environment name you need
  # development:
  #   env_path: "/home/ubuntu/apps/my-product/.env.development"  # [REQUIRED]
  #   image_tag: "dev"                                           # [OPTIONAL]

# ==============================================================================
# Health Check Configuration
# ==============================================================================
health_check:
  endpoint: "/api/health"                    # [OPTIONAL] Health check endpoint (default: /api/health)

  # Docker container health check settings (used by Docker daemon)
  interval: "30s"                            # [OPTIONAL] How often Docker checks (default: 30s)
  timeout: "10s"                             # [OPTIONAL] Max time to wait for response (default: 10s)
  retries: 3                                 # [OPTIONAL] Failed checks before unhealthy (default: 3)
  start_period: "40s"                        # [OPTIONAL] Grace period on startup (default: 40s)

  # Deployment verification (script polls Docker's health status)
  max_retries: 30                            # [OPTIONAL] Max polling attempts (default: 30)
  retry_interval: 2                          # [OPTIONAL] Seconds between polls (default: 2)

# ==============================================================================
# Deployment Options
# ==============================================================================
deployment:
  graceful_shutdown_timeout: 30  # [OPTIONAL] Seconds to wait for old container to shutdown gracefully (default: 30)
                                 # (SIGTERM → SIGKILL timeout)
  enable_auto_rollback: true     # [OPTIONAL] Auto rollback on deployment failure (default: true)

# ==============================================================================
# Docker Configuration
# ==============================================================================
docker:
  # Build configuration
  dockerfile: "Dockerfile"                  # [OPTIONAL] Path to Dockerfile (default: Dockerfile)
                                            # Can be relative to product root (e.g., "docker/Dockerfile.prod")

  # Container runtime configuration
  container_port: 3000                      # [OPTIONAL] Internal port the app listens on (default: 3000)
  restart_policy: "unless-stopped"          # [OPTIONAL] Docker restart policy (default: unless-stopped)
  shutdown_timeout: 30                      # [OPTIONAL] Graceful shutdown timeout in seconds (default: 30)
                                            # Time to wait for container to stop before sending SIGKILL

  # Network configuration
  # Template variables: ${PRODUCT_NAME}, ${ENVIRONMENT}
  network_driver: "bridge"                  # [OPTIONAL] Network driver (default: bridge)
  network_name: "application"               # [OPTIONAL] Network name (supports template variables)
  network_alias: "app"                      # [OPTIONAL] Stable DNS name (supports ${PRODUCT_NAME}, ${ENVIRONMENT} variables)

  # Common environment variables for all environments
  # These are set in the container, separate from .env files
  env_vars:                                 # [OPTIONAL] Environment variables
    NODE_ENV: "production"
    PORT: "3000"

  # Extra hosts mapping (allows container to access host services)
  extra_hosts:                              # [OPTIONAL] Extra host mappings
    - "host.docker.internal:host-gateway"

  # Logging configuration
  logging:                                  # [OPTIONAL] Logging configuration
    driver: "json-file"                     # [OPTIONAL] Logging driver (default: json-file)
    max_size: "10m"                         # [OPTIONAL] Max log file size (default: 10m)
    max_file: 3                             # [OPTIONAL] Max log files to keep (default: 3)

  # Advanced: Raw docker-compose override (optional)
  # Add any Docker Compose configuration here - it will be merged directly
  # This gives you full access to all Docker features without modifying scripts
  # compose_override: |                     # [OPTIONAL] Raw docker-compose YAML override
  #   volumes:
  #     - ./data:/app/data
  #   cap_add:
  #     - SYS_ADMIN
  #   devices:
  #     - /dev/fuse
  #   ulimits:
  #     nofile:
  #       soft: 65536
  #       hard: 65536
  #   security_opt:
  #     - seccomp:unconfined
  #   tmpfs:
  #     - /tmp:rw,noexec,nosuid
  #   # Any valid docker-compose service-level option works here!
